<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Happy Birthday Cherry • High Fireworks + Reliable Input</title>
<style>
  :root { --pink2:#ffd1dc; --bg1:#fff6fa; --bg2:#ffeef4; --bg3:#ffe4ef; }
  html, body { height: 100%; margin:0; padding:0; }
  body { background: radial-gradient(1200px 900px at 50% 20%, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
         display: flex; align-items: center; justify-content: center; }
  .frame { height: 100svh; aspect-ratio: 2/3; background:#fff1f6; border:10px solid var(--pink2);
           border-radius:24px; box-shadow:0 18px 50px rgba(255,140,180,.25), inset 0 0 0 8px rgba(255,221,234,.45);
           overflow:hidden; position:relative; touch-action:none; }
  canvas { width:100%; height:100%; display:block; touch-action:none; }
</style>
</head>
<body>
<div class="frame"><canvas id="stage"></canvas></div>
<audio id="bgm" preload="auto" loop></audio>
<script>
(function(){
  const DENSITY_MULT = 1.6;
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d', { alpha: true });
  const frame = document.querySelector('.frame');

  function resize(){
    const r = frame.getBoundingClientRect();
    canvas.width = Math.round(r.width * devicePixelRatio);
    canvas.height = Math.round(r.height * devicePixelRatio);
  }
  new ResizeObserver(resize).observe(frame);
  addEventListener('resize', resize);
  resize();

  let bgReady=false; const bg=new Image();
  bg.onload=()=>bgReady=true; bg.onerror=()=>bgReady=false; bg.src='snc.png';

  function drawCover(img, cw, ch){
    if(!img.width||!img.height) return;
    const ir=img.width/img.height, cr=cw/ch;
    let dw,dh,dx,dy;
    if(ir>cr){ dh=ch; dw=dh*ir; dx=(cw-dw)/2; dy=0; } else { dw=cw; dh=dw/ir; dx=0; dy=(ch-dh)/2; }
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  const fireworks=[], particles=[];
  const pastel=['#ff99bb','#ffc2e2','#ffd6e7','#ffb6c9','#ffd1dc','#f8c8dc','#ffcad4','#ffd2da'];
  const GRAV_F=0.012, GRAV_P=0.0016;
  const rand=(a,b)=>Math.random()*(b-a)+a, pick=a=>a[Math.floor(Math.random()*a.length)];

  function spawnFirework(x,targetY){
    const spd=Math.random()*2+3, ang=-Math.PI/2+(Math.random()*0.44-0.22);
    const fuse = Math.max(14, Math.min(90, (canvas.height-targetY)/3.2 + (Math.random()*16-8)));
    fireworks.push({x, y:canvas.height, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd*1.2, fuse, color:pick(pastel), targetY});
  }
  function explode(x,y,c){
    const mult=DENSITY_MULT;
    const n=Math.floor((Math.random()*20+36)*mult);
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2, s=Math.random()*2.5+0.9;
      particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:Math.random()*28+28,size:Math.random()*0.9+1.1,glow:Math.random()*4+5,color:Math.random()<0.22?'#ffffff':c});
    }
    const ring = Math.max(10, Math.floor(10*mult));
    for(let i=0;i<ring;i++){
      const a=(i/ring)*Math.PI*2;
      particles.push({x,y,vx:Math.cos(a)*1.2,vy:Math.sin(a)*1.2,life:Math.random()*16+18,size:2.0,glow:12,color:'#fff0f6'});
    }
  }
  let spawnTimer=0;
  function autoSpawn(dt){
    const rateMult=DENSITY_MULT;
    spawnTimer-=dt;
    if(spawnTimer<=0){
      const topBias = Math.random()<0.45;
      const ty = topBias ? (Math.random()*(canvas.height*0.17)+canvas.height*0.05)
                         : (Math.random()*(canvas.height*0.70)+canvas.height*0.22);
      spawnFirework(Math.random()*(canvas.width*0.9)+canvas.width*0.05, ty);
      if(Math.random()<0.28*rateMult){
        const topBias2 = Math.random()<0.45;
        const ty2 = topBias2 ? (Math.random()*(canvas.height*0.2)+canvas.height*0.05)
                             : (Math.random()*(canvas.height*0.70)+canvas.height*0.22);
        spawnFirework(Math.random()*(canvas.width*0.9)+canvas.width*0.05, ty2);
      }
      spawnTimer=(Math.random()*440+480)/rateMult;
    }
  }
  function stepFireworks(){
    for(let i=fireworks.length-1;i>=0;i--){
      const f=fireworks[i];
      f.x+=f.vx; f.y+=f.vy; f.vy+=GRAV_F; f.fuse-=1;
      ctx.save(); ctx.globalCompositeOperation='lighter';
      const g=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,10);
      g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(1,(f.color||'#ffd1dc')+'aa');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(f.x,f.y,3*devicePixelRatio,0,Math.PI*2); ctx.fill(); ctx.restore();
      if (f.y <= f.targetY || f.fuse<=0 || f.vy>=0){ explode(f.x,f.y,f.color); fireworks.splice(i,1); }
    }
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.x+=p.vx; p.y+=p.vy; p.vy+=GRAV_P; p.life-=1; p.vx*=0.99; p.vy*=0.99;
      ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.shadowBlur=p.glow; ctx.shadowColor=p.color; ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size*devicePixelRatio,0,Math.PI*2); ctx.fill(); ctx.restore();
      if(p.life<=0) particles.splice(i,1);
    }
  }

  const title="HAPPY BIRTHDAY CHERRY"; const bottom="Cục Cưng Xinh Đẹp"; let t=0;
  function drawTexts(){
    const baseW=canvas.width; const px=Math.max(28, Math.min(90, Math.round(baseW*0.065)));
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${px}px "Comic Sans MS", sans-serif`;
    const spacing=px*0.7; let sx=canvas.width/2-((title.length-1)/2)*spacing;
    const ty=Math.max(px*1.05, canvas.height*0.09);
    const pastel=['#ff99bb','#ffc2e2','#ffd6e7','#ffb6c9','#ffd1dc','#f8c8dc','#ffcad4','#ffd2da'];
    for(let i=0;i<title.length;i++){
      const ch=title[i], phase=t*0.012+i*0.4, yOff=Math.sin(phase)*px*0.18;
      const fill=pastel[i%pastel.length];
      ctx.lineWidth=Math.max(5,px*0.14); ctx.strokeStyle='rgba(255,200,230,0.65)'; ctx.shadowColor='rgba(255,170,210,0.9)'; ctx.shadowBlur=Math.max(20,px*0.6); ctx.strokeText(ch, sx+i*spacing, ty+yOff);
      ctx.lineWidth=Math.max(3,px*0.06); ctx.strokeStyle='rgba(255,255,255,0.95)'; ctx.shadowBlur=Math.max(10,px*0.3); ctx.strokeText(ch, sx+i*spacing, ty+yOff);
      ctx.shadowColor=fill; ctx.shadowBlur=Math.max(16,px*0.4); ctx.fillStyle=fill; ctx.fillText(ch, sx+i*spacing, ty+yOff);
    }
    ctx.font=`800 ${Math.round(px*0.9)}px "Comic Sans MS", sans-serif`;
    const bSpacing=px*0.66; sx=canvas.width/2-((bottom.length-1)/2)*bSpacing;
    const by=canvas.height-Math.max(px*0.95, canvas.height*0.09);
    for(let i=0;i<bottom.length;i++){
      const ch=bottom[i], phase=t*0.01+i*0.5, yOff=Math.sin(phase)*px*0.12;
      const fill=i%3===0?'#ffb3cf':(i%3===1?'#ffd1ea':'#ffc2e2');
      ctx.lineWidth=Math.max(3, px*0.05); ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.shadowColor=fill; ctx.shadowBlur=Math.max(12,px*0.35); ctx.fillStyle=fill;
      ctx.strokeText(ch, sx+i*bSpacing, by+yOff); ctx.fillText(ch, sx+i*bSpacing, by+yOff);
    }
    ctx.restore();
  }

  let last=performance.now();
  function loop(now){
    const dt=now-last; last=now; t+=dt;
    if(bgReady){ drawCover(bg, canvas.width, canvas.height); ctx.fillStyle='rgba(255,220,235,0.18)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
    else { const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#fff6fa'); g.addColorStop(0.5,'#ffeef4'); g.addColorStop(1,'#ffe4ef'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height); }
    autoSpawn(dt); stepFireworks(); drawTexts(); requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Reliable input
  let drawing=false, lastEmit=0;
  function spawnAt(clientX, clientY){
    const r=canvas.getBoundingClientRect(), sx=canvas.width/r.width, sy=canvas.height/r.height;
    const cx=(clientX-r.left)*sx, cy=(clientY-r.top)*sy;
    for(let i=0;i<2;i++){
      const tY = Math.max(0, cy - (canvas.height*0.25 + Math.random()*canvas.height*0.3));
      spawnFirework(cx+ (Math.random()*40-20), tY);
    }
  }
  canvas.addEventListener('pointerdown', (e)=>{ e.preventDefault(); drawing=true; lastEmit=performance.now(); try{canvas.setPointerCapture(e.pointerId);}catch{} spawnAt(e.clientX, e.clientY); }, {passive:false});
  canvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; e.preventDefault(); const now=performance.now(); if(now-lastEmit>50){ lastEmit=now; spawnAt(e.clientX, e.clientY);} }, {passive:false});
  const end=()=>{ drawing=false; };
  canvas.addEventListener('pointerup', end); canvas.addEventListener('pointercancel', end); canvas.addEventListener('pointerleave', end);

  // Mouse fallback
  canvas.addEventListener('mousedown', (e)=>{ e.preventDefault(); drawing=true; spawnAt(e.clientX, e.clientY); }, {passive:false});
  addEventListener('mousemove', (e)=>{ if(drawing){ e.preventDefault(); spawnAt(e.clientX, e.clientY); } }, {passive:false});
  addEventListener('mouseup', ()=>{ drawing=false; });

  // Music autoplay/fallback
  const bgm=document.getElementById('bgm');
  (async function initMusic(){
    const tryPlay = async (src) => { try { bgm.src = src; bgm.volume = 0.7; await bgm.play(); return true; } catch(e){ return false; } };
    let ok = await tryPlay('bgmusic.mp3'); if(!ok) ok = await tryPlay('bgmusic.wav');
    if(!ok){ const unlock=async()=>{ if(await tryPlay('bgmusic.mp3')||await tryPlay('bgmusic.wav')) document.removeEventListener('pointerdown',unlock,{passive:true}); };
      document.addEventListener('pointerdown',unlock,{once:true, passive:true}); }
  })();
})();
</script>
</body>
</html>
